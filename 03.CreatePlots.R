# Loading the required libraries
library(caret)
library(xgboost)
library(ggplot2)
library(ggplotify)
library(hrbrthemes)
library(parallel)
library(gridExtra)
library(corrplot)
library(factoextra)
library(FactoMineR)
library(fitdistrplus)
library(dplyr)
library(haven)
library(data.table)
library(matrixStats)

# Defining the target variables
sTgts = c("pcer_pline", "pcer_17_pline")

# Loading the results data
dfIDs = read.csv("xgb_model_dfDatasetIDs.csv")
dfHHIDs = read.csv("xgb_model_dfDatasetHHIDs.csv")
dfResModel = readRDS("xgb_model_featsSTATplus_boostrapped_data_10000samples.RData")

# Adding the HHID data
dfResModel[[1]] = cbind(hhid=dfHHIDs$hhid, dfResModel[[1]])
dfResModel[[2]] = cbind(hhid=dfHHIDs$hhid, dfResModel[[2]])

# Plotting the outputs - Households
for (j in 1:length(sTgts)) {
  
  # Household values ===========================================================
  # Histogram - ADM1 - Distribution of selected households from 10,000 bootstrapped simulations
  sHH = c(14340, 27102, 570, 61)
  sHHID = dfHHIDs$hhid[sHH]
  for (s in 1:length(sHH)) {
    t=paste("Houshold ID - ",sHHID[s],sep="")
    png(filename=paste("dist_households_Bootstrapped_",sTgts[j],"_",sHHID[s],".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfResModel[[j]][sHH[s],9:NCOL(dfResModel[[j]])])), histo=T, demp=T); title(t, line=3)
    dev.off()
  }

  # Histogram - ADM1 - Distribution of all households from 10,000 bootstrapped simulations at ADM1
  sADM1s = c("Sistan and Baluchestan", "Kerman", "Hormozgan", "Fars", "Tehran", "Isfahan", "Mazandaran")
  for (s in sADM1s) {
    t=paste("ADM1 - ",s,sep="")
    png(filename=paste("dist_ADM1households_Bootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfResModel[[j]][dfResModel[[j]]$ADM1_NAME==s,9:NCOL(dfResModel[[j]])])), histo=T, demp=T); title(t, line=3)
    dev.off()
  }

  # Histogram - ADM2 - Distribution of all households from 10,000 bootstrapped simulations at ADM2
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    t=paste("ADM2 - ",s,sep="")
    png(filename=paste("dist_ADM2households_Bootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfResModel[[j]][dfResModel[[j]]$ADM2_NAME==s,9:NCOL(dfResModel[[j]])])), histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================

}
gc()

# Plotting the outputs - Vulnerability score
for (j in 1:length(sTgts)) {
  
  # Vulnerability score using threshold of 0.29 for households =================
  dfResThrs = dfResModel[[j]]
  vThrs = 0.29
  dfResThrs[,9:NCOL(dfResThrs)][dfResThrs[,9:NCOL(dfResThrs)] <  vThrs] = 0
  dfResThrs[,9:NCOL(dfResThrs)][dfResThrs[,9:NCOL(dfResThrs)] >= vThrs] = 1
  dfMeans = cbind(dfResThrs[,1:8], rowMeans(dfResThrs[,9:NCOL(dfResThrs)]), rowMeans(dfResModel[[j]][,9:NCOL(dfResModel[[j]])]))
  names(dfMeans)[(NCOL(dfMeans)-1):NCOL(dfMeans)] = c("Prob", "meanBoot")
  write.csv(dfMeans, paste("dist_households_meanThreshold_AllHouseholds_",sTgts[j],"_IRN.csv",sep=""), row.names=F)
  
  # Adding this data to ADM1 and ADM2 maps
  dfMeansADM1 = dfMeans %>% group_by(adm0_code,adm1_code,ADM0_NAME,ADM1_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              meanBoot_mean = mean(meanBoot), 
              meanBoot_median = median(meanBoot), 
              .groups = 'drop')
  names(dfMeansADM1)[1:2] = c("ADM0_CODE","ADM1_CODE")
  dfMeansADM2 = dfMeans %>% group_by(adm0_code,adm1_code,adm2_code,ADM0_NAME,ADM1_NAME,ADM2_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              meanBoot_mean = mean(meanBoot), 
              meanBoot_median = median(meanBoot), 
              .groups = 'drop')
  names(dfMeansADM2)[1:3] = c("ADM0_CODE","ADM1_CODE","ADM2_CODE")
  
  # Adding the geometries and saving as gpkg
  library(sf)
  sfADM1 = read_sf("IRN_ADM.gpkg", "IRN_ADM1")
  sfADM2 = read_sf("IRN_ADM.gpkg", "IRN_ADM2")
  sfADM1 = merge(sfADM1, dfMeansADM1, by=c("ADM0_CODE","ADM0_NAME","ADM1_CODE","ADM1_NAME"), all.x=T)
  sfADM2 = merge(sfADM2, dfMeansADM2, by=c("ADM0_CODE","ADM0_NAME","ADM1_CODE","ADM1_NAME","ADM2_CODE","ADM2_NAME"), all.x=T)
  write_sf(sfADM1, paste("dist_ADM1_meanThreshold_AllHouseholds_",sTgts[j],"_IRN.gpkg",sep=""))
  write_sf(sfADM2, paste("dist_ADM2_meanThreshold_AllHouseholds_",sTgts[j],"_IRN.gpkg",sep=""))
  
  # Country level plot - Prob
  png(filename=paste("dist_households_meanThreshold_AllHouseholds_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of the boolean 0.29 threshold of all 10,000 bootstrapped simulations - All households in Iran",sep="")
  plotdist(dfMeans$Prob, histo=T, demp=T); title(t, line=3)
  dev.off()
  png(filename=paste("dist_households_meanThreshold_lower0.5_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of the boolean 0.29 threshold of all 10,000 bootstrapped simulations - Households with mean threshold < 0.5",sep="")
  plotdist(dfMeans$Prob[dfMeans$Prob<0.5], histo=T, demp=T); title(t, line=3)
  dev.off()
  png(filename=paste("dist_households_meanThreshold_greaterequal0.5_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of the boolean 0.29 threshold of all 10,000 bootstrapped simulations - Households with mean threshold >= 0.5",sep="")
  plotdist(dfMeans$Prob[dfMeans$Prob>=0.5], histo=T, demp=T); title(t, line=3)
  dev.off()
  
  # Country level plot - meanBoot
  png(filename=paste("dist_households_meanBootstrapped_AllHouseholds_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of all 10,000 bootstrapped simulations - All households in Iran",sep="")
  plotdist(dfMeans$meanBoot, histo=T, demp=T); title(t, line=3)
  dev.off()
  png(filename=paste("dist_households_meanBootstrapped_lower0.5_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of all 10,000 bootstrapped simulations - Households with mean < 0.5",sep="")
  plotdist(dfMeans$meanBoot[dfMeans$meanBoot<0.5], histo=T, demp=T); title(t, line=3)
  dev.off()
  png(filename=paste("dist_households_meanBootstrapped_greaterequal0.5_",sTgts[j],"_IRN.png",sep=""),width=850,height=350)
  t=paste("Mean of all 10,000 bootstrapped simulations - Households with mean >= 0.5",sep="")
  plotdist(dfMeans$meanBoot[dfMeans$meanBoot>=0.5], histo=T, demp=T); title(t, line=3)
  dev.off()
  
  # Histogram - ADM1 - Distribution of Prob at ADM1
  sADM1s = c("Sistan and Baluchestan", "Kerman", "Hormozgan", "Fars", "Tehran", "Isfahan", "Mazandaran")
  for (s in sADM1s) {
    t=paste("ADM1 - Threshold ",vThrs," - ",s,sep="")
    png(filename=paste("dist_ADM1_meanThreshold_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$Prob[dfMeans$ADM1_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  
  # Histogram - ADM2 - Distribution of Prob at ADM2
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    t=paste("ADM2 - Threshold ",vThrs," - ",s,sep="")
    png(filename=paste("dist_ADM2_meanThreshold_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$Prob[dfMeans$ADM2_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  
  # Histogram - ADM1 - Distribution of meanBoot at ADM1
  sADM1s = c("Sistan and Baluchestan", "Kerman", "Hormozgan", "Fars", "Tehran", "Isfahan", "Mazandaran")
  for (s in sADM1s) {
    t=paste("ADM1 - meanBootstrapped - ",s,sep="")
    png(filename=paste("dist_ADM1_meanBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$meanBoot[dfMeans$ADM1_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  
  # Histogram - ADM2 - Distribution of meanBoot at ADM2
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    t=paste("ADM2 - meanBootstrapped - ",s,sep="")
    png(filename=paste("dist_ADM2_meanBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$meanBoot[dfMeans$ADM2_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
}
gc()

ggplot(dfMeans, aes(x=meanBoot, y=Prob)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  geom_vline(xintercept=0.29, linetype="dashed", color = "darkred", size=0.8) + 
  scale_x_continuous(limits=c(0, 1)) + 
  scale_y_continuous(limits=c(0, 1)) +
  labs(x="Probability of being poor",
       y="Probability of being vulnerable") + 
  theme_ipsum()

# Plotting the outputs - Mean and Median
for (j in 1:length(sTgts)) {
  
  # Mean values ================================================================
  # Consolidating the results - mean values 
  dfMeans = cbind(dfResModel[[j]][,1:8], rowMeans(dfResModel[[j]][,9:NCOL(dfResModel[[j]])]))
  names(dfMeans)[NCOL(dfMeans)] = "Prob"
  
  # Plot of ADM1 poverty
  dfMeansADM1 = dfMeans %>% group_by(ADM1_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              .groups = 'drop')
  dfMeansADM1 = dfMeansADM1[order(dfMeansADM1$Prob_mean, decreasing=T),]
  png(filename=paste("sort_meanADM1_meanBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMeansADM1$Prob_mean, pch=20, type='b', main='ADM1 mean probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  text(dfMeansADM1$Prob_mean, labels=dfMeansADM1$ADM1_NAME, cex=0.6, font=1, pos=4, srt=60)
  dev.off()
  png(filename=paste("sort_medianADM1_meanBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMeansADM1$Prob_median, pch=20, type='b', main='ADM1 median probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  text(dfMeansADM1$Prob_median, labels=dfMeansADM1$ADM1_NAME, cex=0.6, font=1, pos=4, srt=60)
  dev.off()
  
  # Plot of ADM2 poverty
  dfMeansADM2 = dfMeans %>% group_by(ADM2_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              .groups = 'drop')
  dfMeansADM2 = dfMeansADM2[order(dfMeansADM2$Prob_mean, decreasing=T),]
  png(filename=paste("sort_meanADM2_meanBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMeansADM2$Prob_mean, pch=20, main='ADM2 mean probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  dev.off()
  png(filename=paste("sort_medianADM2_meanBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMeansADM2$Prob_median, pch=20, main='ADM2 median probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  dev.off()
  
  # Histogram - ADM1 - Distribution of the mean of 10,000 bootstrapped simulations at ADM1
  sADM1s = c("Sistan and Baluchestan", "Kerman", "Hormozgan", "Fars", "Tehran", "Isfahan", "Mazandaran")
  for (s in sADM1s) {
    t=paste("ADM1 - ",s,sep="")
    png(filename=paste("dist_ADM1_meanBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$Prob[dfMeans$ADM1_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  
  # Histogram - ADM2 - Distribution of the mean of 10,000 bootstrapped simulations at ADM2
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    t=paste("ADM2 - ",s,sep="")
    png(filename=paste("dist_ADM2_meanBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMeans$Prob[dfMeans$ADM2_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
  
  # Median values ==============================================================
  # Consolidating the results - medians values 
  dfMedians = cbind(dfResModel[[j]][,1:8], rowMedians(as.matrix(dfResModel[[j]][,9:NCOL(dfResModel[[j]])])))
  names(dfMedians)[NCOL(dfMedians)] = "Prob"
  
  # Plot of ADM1 poverty
  dfMediansADM1 = dfMedians %>% group_by(ADM1_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              .groups = 'drop')
  dfMediansADM1 = dfMediansADM1[order(dfMediansADM1$Prob_mean, decreasing=T),]
  png(filename=paste("sort_meanADM1_medianBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMediansADM1$Prob_mean, pch=20, type='b', main='ADM1 mean probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  text(dfMediansADM1$Prob_mean, labels=dfMediansADM1$ADM1_NAME, cex=0.6, font=1, pos=4, srt=60)
  dev.off()
  png(filename=paste("sort_medianADM1_medianBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMediansADM1$Prob_median, pch=20, type='b', main='ADM1 median probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  text(dfMediansADM1$Prob_median, labels=dfMediansADM1$ADM1_NAME, cex=0.6, font=1, pos=4, srt=60)
  dev.off()
  
  # Plot of ADM2 poverty
  dfMediansADM2 = dfMedians %>% group_by(ADM2_NAME) %>% 
    summarise(Prob_mean = mean(Prob), 
              Prob_median = median(Prob), 
              .groups = 'drop')
  dfMediansADM2 = dfMediansADM2[order(dfMediansADM2$Prob_mean, decreasing=T),]
  png(filename=paste("sort_meanADM2_medianBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMediansADM2$Prob_mean, pch=20, main='ADM2 mean probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  dev.off()
  png(filename=paste("sort_medianADM2_medianBootstrapped_",sTgts[j],".png",sep=""),width=850,height=400)
  plot(dfMediansADM2$Prob_median, pch=20, main='ADM2 median probability of all households', sub='Sorted by mean value', ylim=c(0,1), ylab='Probability')
  dev.off()
  
  # Histogram - ADM1 - Distribution of the mean of 10,000 bootstrapped simulations at ADM1
  sADM1s = c("Sistan and Baluchestan", "Kerman", "Hormozgan", "Fars", "Tehran", "Isfahan", "Mazandaran")
  for (s in sADM1s) {
    t=paste("ADM1 - ",s,sep="")
    png(filename=paste("dist_ADM1_medianBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMedians$Prob[dfMedians$ADM1_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  
  # Histogram - ADM2 - Distribution of the mean of 10,000 bootstrapped simulations at ADM2
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    t=paste("ADM2 - ",s,sep="")
    png(filename=paste("dist_ADM2_medianBootstrapped_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
    plotdist(dfMedians$Prob[dfMedians$ADM2_NAME==s], histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
  
}
gc()

# Creating the plots with the threshold STATA variables
# Reading the reference data with household data
dfDatasetIDs = read.csv("xgb_model_dfDatasetIDs.csv")
dfDatasetStata = read.csv("xgb_model_dfDatasetStata.csv")

# Plots for selected STATA variables at the household level for all country
for (j in 1:length(sTgts)) {
  
  # head_female ================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1)
  sThrs = c("No", "Yes")
  for (i in 1:length(vThrs)) {
    dfDataPlot = rowMeans(dfData[dfData$head_female==vThrs[i],(NCOL(dfDatasetStata)+9):NCOL(dfData)])
    t=paste("Mean bootstrapped simulations of all households - Head female: ",sThrs[i],sep="")
    png(filename=paste("dist_households_MeanBootstrapped_head_female_",sThrs[i],"_",sTgts[j],".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
  
  # head_education =============================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1, 2, 3, 5, 6, 7, 8, 9)
  sThrs = c("None", "Primary", "Lower secondary", "Upper secondary", "Associates", 
            "Bachelors", "Masters", "Doctorate", "Other_informal")
  for (i in 1:length(vThrs)) {
    dfDataPlot = rowMeans(dfData[dfData$head_education==vThrs[i],(NCOL(dfDatasetStata)+9):NCOL(dfData)])
    if (NROW(dfDataPlot)>0) {
      t=paste("Mean bootstrapped simulations of all households - Head education: ",sThrs[i],sep="")
      png(filename=paste("dist_households_MeanBootstrapped_head_education_",sThrs[i],"_",sTgts[j],".png",sep=""),width=850,height=350)
      plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
      dev.off()
    }
  }
  # ============================================================================
  
  # head_education_grouped =====================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vGrps = list(c(0), c(1), c(2, 3), c(5, 6, 7, 8), c(9))
  sGrps = list("No education", "Primary", "Secondary", "Tertiary", "Other")
  for (i in 1:length(vGrps)) {
    dfDataPlot = rowMeans(dfData[dfData$head_education %in% vGrps[[i]],(NCOL(dfDatasetStata)+9):NCOL(dfData)])
    if (NROW(dfDataPlot)>0) {
      t=paste("Mean bootstrapped simulations of all households - Head education: ",sGrps[[i]],sep="")
      png(filename=paste("dist_households_MeanBootstrapped_head_education_grouped_",sGrps[[i]],"_",sTgts[j],".png",sep=""),width=850,height=350)
      plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
      dev.off()
    }
  }
  # ============================================================================
  
  # urban ======================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1)
  sThrs = c("No", "Yes")
  for (i in 1:length(vThrs)) {
    dfDataPlot = rowMeans(dfData[dfData$urban==vThrs[i],(NCOL(dfDatasetStata)+9):NCOL(dfData)])
    t=paste("Mean bootstrapped simulations of all households - Urban: ",sThrs[i],sep="")
    png(filename=paste("dist_households_MeanBootstrapped_urban_",sThrs[i],"_",sTgts[j],".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
  
  # head_mar ===================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(1, 2, 3, 4)
  sThrs = c("Married", "Widow", "Divorced", "Never-married")
  for (i in 1:length(vThrs)) {
    dfDataPlot = rowMeans(dfData[dfData$head_mar==vThrs[i],(NCOL(dfDatasetStata)+9):NCOL(dfData)])
    t=paste("Mean bootstrapped simulations of all households - Head marital status: ",sThrs[i],sep="")
    png(filename=paste("dist_households_MeanBootstrapped_head_mar_",sThrs[i],"_",sTgts[j],".png",sep=""),width=850,height=350)
    plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
    dev.off()
  }
  # ============================================================================
  
  # hhsize =====================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = 3.61
  # Lower threshold
  dfDataPlot = rowMeans(dfData[dfData$hhsize<vThrs,(NCOL(dfDatasetStata)+9):NCOL(dfData)])
  t=paste("Mean bootstrapped simulations of all households - hhsize lower than ",vThrs,sep="")
  png(filename=paste("dist_households_MeanBootstrapped_hhsize_lower_",vThrs,"_",sTgts[j],".png",sep=""),width=850,height=350)
  plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
  dev.off()
  # Higher equal threshold
  dfDataPlot = rowMeans(dfData[dfData$hhsize>=vThrs,(NCOL(dfDatasetStata)+9):NCOL(dfData)])
  t=paste("Mean bootstrapped simulations of all households - hhsize higher or equal than ",vThrs,sep="")
  png(filename=paste("dist_households_MeanBootstrapped_hhsize_higherequal_",vThrs,"_",sTgts[j],".png",sep=""),width=850,height=350)
  plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
  dev.off()
  # ============================================================================
  
}
gc()

# Plots for selected STATA variables at the ADM2 level
for (j in 1:length(sTgts)) {
  
  # head_female ================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1)
  sThrs = c("No", "Yes")
  for (i in 1:length(vThrs)) {
    # Histogram - ADM2 - Distribution of all households from 10,000 bootstrapped simulations at ADM2
    sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
    for (s in sADM2s) {
      dfDataPlot = dfData[dfData$head_female==vThrs[i] & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
      if (NROW(dfDataPlot) > 0) {
        t=paste("ADM2 - ",s," - Head female - ",sThrs[i],sep="")
        png(filename=paste("dist_ADM2households_Bootstrapped_head_female_",sThrs[i],"_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
        plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
        dev.off()
      }
    }
  }
  # ============================================================================
  
  # head_education =============================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1, 2, 3, 5, 6, 7, 8, 9)
  sThrs = c("None", "Primary", "Lower secondary", "Upper secondary", "Associates", 
            "Bachelors", "Masters", "Doctorate", "Other_informal")
  for (i in 1:length(vThrs)) {
    # Histogram - ADM2 - Distribution of all households from 10,000 bootstrapped simulations at ADM2
    sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
    for (s in sADM2s) {
      dfDataPlot = dfData[dfData$head_education==vThrs[i] & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
      if (NROW(dfDataPlot) > 0) {
        t=paste("ADM2 - ",s," - Head education - ",sThrs[i],sep="")
        png(filename=paste("dist_ADM2households_Bootstrapped_head_education_",sThrs[i],"_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
        plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
        dev.off()
      }
    }
  }
  # ============================================================================
  
  # urban ======================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(0, 1)
  sThrs = c("No", "Yes")
  for (i in 1:length(vThrs)) {
    # Histogram - ADM2 - Distribution of all households from 10,000 bootstrapped simulations at ADM2
    sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
    for (s in sADM2s) {
      dfDataPlot = dfData[dfData$urban==vThrs[i] & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
      if (NROW(dfDataPlot) > 0) {
        t=paste("ADM2 - ",s," - Urban - ",sThrs[i],sep="")
        png(filename=paste("dist_ADM2households_Bootstrapped_urban_",sThrs[i],"_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
        plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
        dev.off()
      }
    }
  }
  # ============================================================================
  
  # head_mar ===================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = c(1, 2, 3, 4)
  sThrs = c("Married", "Widow", "Divorced", "Never-married")
  for (i in 1:length(vThrs)) {
    # Histogram - ADM2 - Distribution of all households from 10,000 bootstrapped simulations at ADM2
    sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
    for (s in sADM2s) {
      dfDataPlot = dfData[dfData$head_mar==vThrs[i] & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
      if (NROW(dfDataPlot) > 0) {
        t=paste("ADM2 - ",s," - Head marital status - ",sThrs[i],sep="")
        png(filename=paste("dist_ADM2households_Bootstrapped_head_mar_",sThrs[i],"_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
        plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
        dev.off()
      }
    }
  }
  # ============================================================================
  
  # hhsize =====================================================================
  dfData = cbind(dfDatasetStata, dfResModel[[j]])
  vThrs = 3.61
  sADM2s = c("Bashagard", "Fahraj", "Nimrouz", "Azna", "Pakdasht", "Tehran", "Isfahan")
  for (s in sADM2s) {
    # Lower threshold
    dfDataPlot = dfData[dfData$hhsize<vThrs & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
    if (NROW(dfDataPlot) > 0) {
      t=paste("ADM2 - ",s," - hhsize < ",vThrs,sep="")
      png(filename=paste("dist_ADM2households_Bootstrapped_hhsize_lower_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
      plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
      dev.off()
    }
    # Higher equal threshold
    dfDataPlot = dfData[dfData$hhsize>=vThrs & dfData$ADM2_NAME==s,(NCOL(dfDatasetStata)+9):NCOL(dfData)]
    if (NROW(dfDataPlot) > 0) {
      t=paste("ADM2 - ",s," - hhsize >= ",vThrs,sep="")
      png(filename=paste("dist_ADM2households_Bootstrapped_hhsize_higherequal_",sTgts[j],"_",s,".png",sep=""),width=850,height=350)
      plotdist(unlist(c(dfDataPlot)), histo=T, demp=T); title(t, line=3)
      dev.off()
    }
  }
  # ============================================================================
  
}
gc()
