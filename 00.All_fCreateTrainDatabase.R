# Loading the required libraries
library(sf)
library(lubridate)
library(reshape2)
library(haven)
library(dplyr)
library(ggplot2)
library(hrbrthemes)

# Loading the drought data
dfData = read.csv("Yearly_Summary_ADM2.csv")

# Getting the list of years in dfRes
dfYears = unlist(unique(data.frame(Year=dfData$Year)))

# Reading the STATA .dta data, filtering by Year with dfRes, and adding ADM codes&names
dfStata = read_dta("drought_adm2_merged.dta")
dfStata = dfStata[dfStata$year %in% dfYears,,drop=FALSE]

# Keeping just selected columns and dropping NAs of dfStata
sIDColumns = c("hhid", "adm0_code", "adm1_code", "adm2_code", "year")
sTgtColumns = c("pcer", "pcer_17")
dfStata = dfStata[,names(dfStata) %in% c(sIDColumns, sTgtColumns), drop=FALSE]
dfStata = na.omit(dfStata)
dfStata = dfStata[!dfStata$adm0_code=="",,drop=FALSE]
dfStata = dfStata[!dfStata$adm1_code=="",,drop=FALSE]
dfStata = dfStata[!dfStata$adm2_code=="",,drop=FALSE]

# Aggregating the household data per ADM2 level - MEAN
dfStataADM2 = dfStata %>% 
  group_by(adm0_code, adm1_code, adm2_code, year) %>% 
  summarise(pcer_mean=mean(pcer), 
            pcer_q10=quantile(pcer, probs=0.1), 
            pcer_q90=quantile(pcer, probs=0.9), 
            pcer_17_mean=mean(pcer_17), 
            pcer_17_q10=quantile(pcer_17, probs=0.1), 
            pcer_17_q90=quantile(pcer_17, probs=0.9), 
            .groups='drop')
# Plotting the results
# IR028015 - Tehran
sADM2_CODE = "IR028015"
sADM2_NAME = "Tehran"
plotPcer = ggplot(dfStataADM2[dfStataADM2$adm2_code==sADM2_CODE,,drop=FALSE], aes(x=year)) +
  geom_line(aes(y = pcer_q10), colour="grey75") + 
  geom_line(aes(y = pcer_mean), colour="black", linetype="dashed", linewidth=1) + 
  geom_line(aes(y = pcer_q90), colour="grey75") + 
  geom_ribbon(aes(ymin = pcer_q10, ymax = pcer_q90), fill = "grey75", alpha = .3) + 
  scale_x_discrete(limits=seq(dfYears[1], dfYears[length(dfYears)], 1)) +
  labs(subtitle=sADM2_NAME, y="pcer", x="Year", title="pcer", caption = "Source: WB data") +
  theme_bw()
plot(plotPcer)
plotPcer17 = ggplot(dfStataADM2[dfStataADM2$adm2_code==sADM2_CODE,,drop=FALSE], aes(x=year)) +
  geom_line(aes(y = pcer_17_q10), colour="grey75") + 
  geom_line(aes(y = pcer_17_mean), colour="black", linetype="dashed", linewidth=1) + 
  geom_line(aes(y = pcer_17_q90), colour="grey75") + 
  geom_ribbon(aes(ymin = pcer_17_q10, ymax = pcer_17_q90), fill = "grey75", alpha = .3) + 
  scale_x_discrete(limits=seq(dfYears[1], dfYears[length(dfYears)], 1)) +
  labs(subtitle=sADM2_NAME, y="pcer_17", x="Year", title="pcer_17", caption = "Source: WB data") +
  theme_bw()
plot(plotPcer17)
# IR010004 - Bashagard
sADM2_CODE = "IR010004"
sADM2_NAME = "Bashagard"
plotPcer = ggplot(dfStataADM2[dfStataADM2$adm2_code==sADM2_CODE,,drop=FALSE], aes(x=year)) +
  geom_line(aes(y = pcer_q10), colour="grey75") + 
  geom_line(aes(y = pcer_mean), colour="black", linetype="dashed", linewidth=1) + 
  geom_line(aes(y = pcer_q90), colour="grey75") + 
  geom_ribbon(aes(ymin = pcer_q10, ymax = pcer_q90), fill = "grey75", alpha = .3) + 
  scale_x_discrete(limits=seq(dfYears[1], dfYears[length(dfYears)], 1)) +
  labs(subtitle=sADM2_NAME, y="pcer", x="Year", title="pcer", caption = "Source: WB data") +
  theme_bw()
plot(plotPcer)
plotPcer17 = ggplot(dfStataADM2[dfStataADM2$adm2_code==sADM2_CODE,,drop=FALSE], aes(x=year)) +
  geom_line(aes(y = pcer_17_q10), colour="grey75") + 
  geom_line(aes(y = pcer_17_mean), colour="black", linetype="dashed", linewidth=1) + 
  geom_line(aes(y = pcer_17_q90), colour="grey75") + 
  geom_ribbon(aes(ymin = pcer_17_q10, ymax = pcer_17_q90), fill = "grey75", alpha = .3) + 
  scale_x_discrete(limits=seq(dfYears[1], dfYears[length(dfYears)], 1)) +
  labs(subtitle=sADM2_NAME, y="pcer_17", x="Year", title="pcer_17", caption = "Source: WB data") +
  theme_bw()
plot(plotPcer17)

# # Aggregating the data per household - MEAN
# dfStataHHID = dfStata %>% 
#   group_by(adm0_code, adm1_code, adm2_code, year, hhid) %>% 
#   summarise(pcer_mean=mean(pcer), 
#             pcer_q10=quantile(pcer, probs=0.1), 
#             pcer_q90=quantile(pcer, probs=0.9), 
#             pcer_17_mean=mean(pcer_17), 
#             pcer_17_q10=quantile(pcer_17, probs=0.1), 
#             pcer_17_q90=quantile(pcer_17, probs=0.9), 
#             .groups='drop')

# Combining the Droughts and Poverty data
dfRes = merge(dfData, dfStata, 
              by.x=c("ADM0_CODE", "ADM1_CODE", "ADM2_CODE", "Year"),
              by.y=c("adm0_code", "adm1_code", "adm2_code", "year"),
              all.x=TRUE)

# Scatter plot of pcer and pcer_17 variables
xmin = 0
xmax = 500000000
ggplot(dfRes, aes(x=pcer, y=pcer_17)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  scale_x_continuous(limits = c(xmin, xmax)) + 
  scale_y_continuous(limits = c(xmin, xmax)) +
  theme_ipsum()

# Saving the results to disk
write.csv(dfRes, "Yearly_Summary_TrainingData.csv", row.names=FALSE)
